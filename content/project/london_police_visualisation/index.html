---
title: "Metropolitan Police Stop and Search Data"
author: 
  - admin
date: "2021-11-23"

tags:
  - DataVis
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>Here are some results from my workings with the the London metropolitan police data for a LBS school assignment and the visualisations I have come up with.</p>
<p>You can find the data for this visualisation on <a href="https://data.police.uk/data/">here</a></p>
<div id="met-police" class="section level1">
<h1>MET Police</h1>
<pre class="r"><code>library(readxl)
library(dplyr)
library(stringr)
# load 2021 September data
stop_search_2021 &lt;- readr::read_csv(here::here(&quot;csv&quot;,&quot;stop-search&quot;,&quot;stop-search&quot;,&quot;2021-09&quot;,&quot;2021-09-metropolitan-stop-and-search.csv&quot;))</code></pre>
<pre class="r"><code>ward_population &lt;- read_excel(path = here::here(&quot;csv&quot;,&quot;stop-search&quot;,&quot;/London-wards-2018_ESRI/CT0225_2011 Census - Age by ethnic group (based on CT0010) by sex - London HT wards.xlsx&quot;),
                              sheet = &quot;CT0225 - All usual residents&quot;,
                              skip = 11,
                              col_names = T,
                              range = &quot;A11:VA674&quot;)%&gt;%
  janitor::clean_names()

for(i in 4:573){
  if(!is.na(ward_population[1,i])){
    temp &lt;- ward_population[1,i]
  }
  else{
    ward_population[1,i] &lt;- temp
  }
}

names(ward_population)[4:length(ward_population)] &lt;- paste0(ward_population[1,],&quot;_&quot;,ward_population[2,])[4:length(ward_population)]

ward_population &lt;- ward_population%&gt;%
  janitor::clean_names()

ward_population &lt;- ward_population[-c(1,2),]

ward_population &lt;- ward_population%&gt;%
  # rename(area_code = x1,
  #        area_name = x2,
  #        total_population = x3)%&gt;%
  mutate(area_code = case_when(!is.na(x1) ~ str_split_fixed(ward_population$x1,&quot; &quot;,2)[,1],
                               TRUE ~ str_split_fixed(ward_population$x2,&quot; &quot;,2)[,1]),
         .after = x1,
         area_name = case_when(!is.na(x1) ~ str_split_fixed(ward_population$x1,&quot; &quot;,2)[,2],
                               TRUE ~ str_split_fixed(ward_population$x2,&quot; &quot;,2)[,2]),
         population_total = x3)

ward_population &lt;-  subset(ward_population, select = -c(x1,x2,x3))


indx_black &lt;- grepl(&#39;black&#39;, colnames(ward_population))

black_pop_total&lt;-rowSums(data.frame(lapply(ward_population[which(indx_black)], as.numeric)))

ward_population_no_age &lt;- ward_population%&gt;%
  mutate(black_population = black_pop_total,
         population_total = as.numeric(population_total))%&gt;%
  select(area_code,
         area_name,
         population_total,
         black_population)%&gt;%
  mutate(prc_black = black_population/population_total)</code></pre>
<pre class="r"><code>library(leaflet)
library(sf)
## Linking to GEOS 3.9.1, GDAL 3.2.3, PROJ 7.2.1
library(ggplot2)
library(dplyr)
library(leaflet.extras)


# read in the shapefile, transform it into long lat format
wards &lt;- st_read(here::here(&quot;csv&quot;,&quot;stop-search&quot;,&quot;London-wards-2018_ESRI/London_Ward_CityMerged.shp&quot;))
## Reading layer `London_Ward_CityMerged&#39; from data source 
##   `/Users/kazmernagy-betegh/Library/Mobile Documents/com~apple~CloudDocs/LBS/AM01_Applied Statistics/my_website/csv/stop-search/London-wards-2018_ESRI/London_Ward_CityMerged.shp&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 633 features and 6 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 503568.2 ymin: 155850.8 xmax: 561957.5 ymax: 200933.9
## Projected CRS: OSGB 1936 / British National Grid
wards &lt;- st_transform(wards,crs=4326)

# transform points to sf
stops_sf &lt;- st_as_sf(stop_search_2021%&gt;%select(Longitude, Latitude)%&gt;%na.omit,coords = c(&#39;Longitude&#39;,&quot;Latitude&quot;), crs = st_crs(wards))

# intersection of polygons and points
stop_locations &lt;- stops_sf %&gt;% 
  mutate(intersection = as.integer(st_intersects(geometry, wards$geometry)),
         area = if_else(is.na(intersection), &#39;&#39;, wards$NAME[intersection])) 

# split geometry in coordinates
stop_locations &lt;- stop_locations%&gt;%
  mutate(X= st_coordinates(geometry)[,1],
         Y= st_coordinates(geometry)[,2])

# join areas to stop search
stop_search_2021 &lt;- left_join(stop_search_2021, stop_locations, by = c(&quot;Longitude&quot; = &quot;X&quot;, &quot;Latitude&quot; = &quot;Y&quot; ))

stop_search_2021_wards &lt;- left_join(stop_search_2021, wards, by = c(&quot;area&quot;= &quot;NAME&quot;))

stop_search_2021_wards &lt;- stop_search_2021_wards%&gt;%
  rename(point_geometry = geometry.x,
         geometry = geometry.y)

# stop_search_2021_wards &lt;- stop_search_2021_wards%&gt;%select(-c(&quot;geometry&quot;))


stop_search_2021_wards_pop &lt;- left_join(stop_search_2021_wards,ward_population_no_age, by = c(&quot;area&quot; = &quot;area_name&quot;))

stop_search_2021_wards_pop &lt;- stop_search_2021_wards_pop%&gt;%
  janitor::clean_names()

# stop_search_2021_wards &lt;- st_transform(stop_search_2021_wards,crs=4326)

prc_balck_stops_per_area &lt;- stop_search_2021_wards_pop%&gt;%
  filter(!is.na(area), area != &quot;&quot;, !is.na(officer_defined_ethnicity))%&gt;%
  group_by(area, officer_defined_ethnicity)%&gt;%
  summarise(ethnic_stops = n())%&gt;%
  mutate(prc_ethnic_stops = ethnic_stops/sum(ethnic_stops))%&gt;%
  filter(officer_defined_ethnicity == &quot;Black&quot;)
## `summarise()` has grouped output by &#39;area&#39;. You can override using the `.groups` argument.

prc_balck_stops_per_area &lt;- merge(prc_balck_stops_per_area, data.frame(wards$NAME), by.x = &quot;area&quot;, by.y = &quot;wards.NAME&quot;, all.y = T)

pal &lt;-  colorNumeric(&quot;OrRd&quot;, stop_locations$intersection)


map_london &lt;- leaflet()%&gt;%
  addTiles(
    options = tileOptions(minZoom = 10, maxZoom = 15)
    )%&gt;%
  addControl(&quot;London Stop and Search Frequency&quot;, position = &#39;bottomleft&#39;)%&gt;%
  setMaxBounds(lng1 = -0.147949,
               lng2 = -0.117949,
               lat1 = 51.20775,
               lat2 = 51.70775)%&gt;%
  addPolygons(data = wards,
              color = &#39;blue&#39;,
              fillOpacity = 0.05,
              weight = 0.5,
              fill = ,
              popup = ~paste0(NAME,&quot; num. stops: &quot;,stop_locations$intersection[stop_locations$area == NAME],
                              &quot;; &quot;,&quot;Black Population: &quot;,round(stop_search_2021_wards_pop$prc_black[which(stop_search_2021_wards_pop$area == NAME)]*100,2),&quot;%&quot;,
                              &quot;; &quot;))%&gt;%
  addHeatmap(group = &quot;heat&quot;,
             data = stop_locations%&gt;%na.omit,
             lng = ~as.numeric(stop_locations$X),
             lat = ~as.numeric(stop_locations$Y),
             intensity = stop_locations$intersection,
             radius = 8,
             minOpacity = 0.1,
             max = 0.7,
             gradient = &quot;OrRd&quot;)%&gt;%
  addLegend(values = stop_locations$intersection%&gt;%na.omit,
            group = &quot;heat&quot;,
            pal =  colorNumeric(&quot;OrRd&quot;,stop_locations$intersection),
            title = &quot;Number of Stop and Searches&quot;)
</code></pre>
<iframe seamless src="/leaflet/leafMap.html" width="100%" height="500">
</iframe>
<pre class="r"><code>library(tidyr)

london_ethnic_dist &lt;- data.frame(as.factor(c(&quot;White&quot;, &quot;Black&quot;, &quot;Asian&quot;, &quot;Other&quot;)),
                                 c(59.8,18.4,13.3, 8.4))

colnames(london_ethnic_dist) &lt;- c(&quot;ethnicity&quot;, &quot;prc&quot;)
  
plot1 &lt;- stop_search_2021%&gt;%
  janitor::clean_names()%&gt;%
  filter(!is.na(officer_defined_ethnicity), !is.na(self_defined_ethnicity))%&gt;%
  group_by(officer_defined_ethnicity)%&gt;%
  summarise(num_stops = n())%&gt;%
  mutate(prc_stops = round(num_stops/sum(num_stops)*100,2))%&gt;%
  mutate(prc = c(18.4,13.3, 8.4, 59.8))%&gt;%
  pivot_longer(cols = 3:4, names_to = &quot;type&quot;, names_repair = &quot;unique&quot;, values_to = &quot;prc&quot;)%&gt;%
  ggplot()+
  geom_col(aes(y = reorder(officer_defined_ethnicity, prc),
               x = prc,
               fill = type),
           position = &quot;dodge&quot;)+
  geom_text(aes(y = reorder(officer_defined_ethnicity,prc),  
                x = prc, 
                label = paste0(prc,&quot;%&quot;),
                group = type),
            position = position_dodge(width = 1),
            fontface = 2)+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        plot.caption.position = &quot;plot&quot;,
        plot.caption = element_text(vjust = 2, hjust = 0))+
  labs(title = &quot;40% of Stop and Searches conducted on 13% of Londons population&quot;,
       y = &quot;&quot;,
       x = &quot;% of Stop and Search Conducted in 2021 September&quot;,
       caption = &quot;NOTE: Ethnicity Breakdown of London from Wikipedia&quot;)+
  scale_fill_manual(values=c(&quot;skyblue&quot;, &quot;tomato&quot;), 
                       name=&quot;% distribution&quot;,
                       
                       labels=c(&quot;Ethnic Distribution of London&quot;, &quot;Stop and Search Ethnic Distribution&quot;))
  

plot1</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code>plot2 &lt;- stop_search_2021%&gt;%
  janitor::clean_names()%&gt;%
  filter(!is.na(officer_defined_ethnicity), !is.na(self_defined_ethnicity))%&gt;%
  mutate(self_id = case_when(grepl(&quot;Black&quot;,self_defined_ethnicity)~&quot;Black&quot;,
                             grepl(&quot;White&quot;,self_defined_ethnicity)~&quot;White&quot;,
                             grepl(&quot;Asian&quot;,self_defined_ethnicity)~&quot;Asian&quot;,
                             TRUE ~ &quot;Other&quot;))%&gt;%
  pivot_longer(cols = c(self_id, officer_defined_ethnicity), names_to = &quot;classificaiton_type&quot;, values_to = &quot;ethnicity&quot;)%&gt;%
  group_by(classificaiton_type, ethnicity)%&gt;%
  summarise(num_stops = n())%&gt;%
  mutate(prc_stops = round(num_stops/sum(num_stops)*100,2))%&gt;%
  ggplot()+
  geom_col(aes(y = reorder(ethnicity, prc_stops),
               x = prc_stops,
               fill = classificaiton_type),
           position = &quot;dodge&quot;)+
  geom_text(aes(y = reorder(ethnicity,prc_stops),  
                x = prc_stops, 
                label = paste0(prc_stops,&quot;%&quot;),
                group = classificaiton_type),
            position = position_dodge(width = 1),
            fontface = 2)+
  theme_minimal()+
  theme(panel.grid.major = element_blank(),
        plot.caption.position = &quot;plot&quot;,
        plot.caption = element_text(vjust = 2, hjust = 0))+
  labs(title = &quot;Only 63% of People Identified as Black by Officers Self Identify as that&quot;,
       y = &quot;&quot;,
       x = &quot;% of Stop and Search Conducted in 2021 September&quot;)+
  scale_fill_manual(values=c( &quot;tomato&quot;, &quot;skyblue&quot;), 
                       name=&quot;&quot;,
                       
                       labels=c(&quot;Self Defined Ethnicity&quot;, &quot;Officer Defined Ethicity&quot;))</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;classificaiton_type&#39;. You can override using the `.groups` argument.</code></pre>
<pre class="r"><code>plot2</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-2.png" width="672" /></p>
</div>
